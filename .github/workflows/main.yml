name: Build Image

on:
  push:
    branches:
      - main

jobs:
  build-dev:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v1
      - uses: xxx/feishu-bot@v1
        with:
          uuid: xxxxxx
          text: |
            {"title":"Dashboardå¼€å§‹ç¼–è¯‘  ${{github.run_id}}"}
      - name: Use Node.js 12.x
        uses: actions/setup-node@v1
        with:
          node-version: 12.x
      - uses: actions/cache@v2
        with:
          path: '**/node_modules'
          key: build-${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}
      - name: npm install, build, and test
        run: |
          yarn
          rm .env.production
          mv .env.sandbox .env.production
          yarn build
        env:
          CI: true
          NPM_CONFIG_USERCONFIG: .npmrc.ci
          NPM_AUTH_TOKEN: ${{ secrets.PKG_TOKEN }}
      - name: deploy
        run: npx static-deploy-tool sync build dev/dashboard -k xxx-s ${{ secrets.DEPLOY_SK }} -b xxx-exxx
      - uses: xxx/feishu-bot@v1
        with:
          uuid: xxxx
          text: |
            {"title":"ğŸ‰ Dashboardç¼–è¯‘æˆåŠŸ ${{github.run_id}}","text":"<a href=\"https://xxx.xxx.xxx/xxx/\">æŸ¥çœ‹devæ²™ç›’ç¯å¢ƒ</a>, \n<a href=\"xxxl\">éƒ¨ç½²çº¿ä¸Šç¯å¢ƒ</a>(è¯·å…ˆåœ¨æœ¬åœ°æ‰§è¡Œe2eæµ‹è¯•)"}
      - if: ${{ failure() }}
        uses: xxx/feishu-bot@v1
        with:
          uuid: xxx
          text: |
            {"title":"ğŸ’£ Dashboardç¼–è¯‘å¤±è´¥ ${{github.run_id}}","text":"<a href=\"xxx\">æŸ¥çœ‹ Action ${{github.run_id}}</a>"}
